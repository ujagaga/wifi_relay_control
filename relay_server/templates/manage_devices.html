<!-- templates/manage_devices.html -->
{% extends "base.html" %}

{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/manage_devices.css') }}">

    <div class="user_picture_wrapper">
      <img src="{{ user.picture }}" alt="Your Picture" class="user_picture">
    </div>

    <nav class="admin_nav">
      <a href="/" class="nav_btn"><i class="fa-solid fa-home"></i></a>
    </nav>

    <div class="flash_message">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <p class="red_notification">{{ messages[0] }}</p>
        {% endif %}
      {% endwith %}
    </div>

    {% if not single_device_mode and not authorized_devices %}
      <p style="color: red;">Warning: No devices found.</p>
    {% endif %}

    <h2>Mode of Operation</h2>
    <form method="post" action="{{ url_for('toggle_device_mode') }}" style="margin-bottom: 2em;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="mode-selector">
        <label>
          <input type="radio" name="mode" value="single"
                 {% if single_device_mode %}checked{% endif %}
                 onchange="this.form.submit()">
          Single Device
        </label>
        <label>
          <input type="radio" name="mode" value="multi"
                 {% if not single_device_mode %}checked{% endif %}
                 onchange="this.form.submit()">
          Multi Device
        </label>
      </div>
    </form>

    <h2>Pending Devices</h2>

    {% if unauthorized_devices %}
      {% for dev in unauthorized_devices %}
      <form method="post" action="{{ url_for('manage_devices_post') }}">
        <div class="device_row">
          <div class="device_card device_config">
            <h2>{{ dev.name }}</h2>
            <p><strong>Last Ping:</strong>
            {% if dev.ping_at %}
              <span class="ping_time" data-iso="{{ dev.ping_at }}">UTC: {{ dev.ping_at }}</span>
            {% else %}
              Never
            {% endif %}
          </p>
          </div>

          <div class="update_buttons">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <input type="hidden" name="device_name" value="{{ dev.name }}">
            <button type="submit" name="action" value="authorize" class="save_btn">
              <i class="fa-solid fa-thumbs-up"></i>
            </button>
            <button type="submit" name="action" value="remove" class="save_btn" style="margin-top:0.5em;">
              <i class="fa-solid fa-trash-can"></i>
            </button>
          </div>
        </div>
      </form>
      {% endfor %}
    {% else %}
      <p>No pending devices.</p>
    {% endif %}

    <h2>Configure Authorized Devices</h2>

    {% if authorized_devices %}
      {% for device in authorized_devices %}
      <form method="post" action="{{ url_for('manage_devices_post') }}">
        <div class="device_row">
          <div class="device_card device_config {% if single_device_mode and device.name != 'main' %}disabled{% endif %}">
            <h3>{{ device.name }}</h3>

            {% if device.ping_at %}
              <p><strong>Last Ping:</strong>
                <span class="ping_time" data-iso="{{ device.ping_at }}">UTC: {{ device.ping_at }}</span>
              </p>
            {% else %}
              <p><strong>Last Ping:</strong> N/A</p>
            {% endif %}

            <label for="{{ device.name }}_label">Label:</label>
            <input type="text" name="{{ device.name }}_label" id="{{ device.name }}_label" value="{{ device.data.label }}">

            <label for="{{ device.name }}_sw_count">Buttons:</label>
            <select name="{{ device.name }}_sw_count" id="{{ device.name }}_sw_count">
              {% for i in range(1, 5) %}
              <option value="{{ i }}" {% if device.data.sw_count == i %} selected {% endif %}>{{ i }}</option>
              {% endfor %}
            </select>

            <label for="{{ device.name }}_reset_at">Restart At (hour 0â€“23):</label>
            <input type="number"
                   name="{{ device.name }}_reset_at"
                   id="{{ device.name }}_reset_at"
                   value="{{ device.data.reset_at }}"
                   min="0"
                   max="23"
                   step="1">
          </div>

          <div class="update_buttons"
               {% if single_device_mode and device.name != 'main' %}style="display:none;"{% endif %}>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="device_name" value="{{ device.name }}">

            <button type="submit" name="action" value="update_single" class="save_btn">
              <i class="fa-solid fa-floppy-disk"></i>
            </button>
            <button type="submit" name="action" value="remove" class="save_btn" style="margin-top:0.5em;">
              <i class="fa-solid fa-trash-can"></i>
            </button>
          </div>
        </div>
      </form>
      {% endfor %}

    {% else %}
      <p>No authorized devices to configure.</p>
    {% endif %}

    <h2>Firmware Update</h2>

    <!-- Upload form -->
    <form id="firmware_form" method="post" action="{{ url_for('upload_firmware') }}" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="file" id="firmware_file" name="firmware_file" accept=".bin" required style="display:none;">
      <label for="firmware_file" class="upload_label">
        <i class="fa-solid fa-upload"></i>
      </label>
    </form>

    <!-- List of uploaded firmware files -->
    {% if firmware_files %}
    <ul class="firmware_list" style="padding:0; margin:0;">
      {% for fw in firmware_files %}
        <li class="firmware_item"
            style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5em;padding:0.5em;border-radius:6px;background:#fafafa;">
          <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:0.5em;">{{ fw }}</span>

          <div style="display:flex;gap:0.4em;align-items:center;">
            <!-- Update button: opens modal -->
            <button type="button"
                    class="save_btn"
                    onclick="openUpdateModal('{{ fw }}')"
                    title="Update firmware {{ fw }}">
              <i class="fa-solid fa-arrow-up-from-bracket"></i>
            </button>

            <!-- Delete form (keeps existing behavior) -->
            <form method="post" action="{{ url_for('delete_firmware') }}" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="filename" value="{{ fw }}">
              <button type="submit" class="save_btn" title="Delete Firmware" style="background-color:#b33;">
                <i class="fa-solid fa-trash"></i>
              </button>
            </form>
          </div>
        </li>
      {% endfor %}
    </ul>

    <!-- Reusable modal (initially hidden) -->
    <div id="updateModal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal-content" role="document" tabindex="-1">
        <button class="modal-close" aria-label="Close" onclick="closeUpdateModal()">&times;</button>
        <h3 style="margin-top:0;">Update firmware <span id="modalFirmwareName" style="font-weight:600;"></span></h3>

        <form id="startUpdateForm" method="post" action="{{ url_for('start_update') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="firmware" id="modalFirmwareInput" value="">

          <div class="device_choices" id="deviceChoices"
             style="max-height:300px;overflow:auto;padding:0.5em;border:1px solid #eee;border-radius:6px;margin-bottom:0.75em;">
            {% if authorized_devices %}
              {% for device in authorized_devices %}
                {% if device.name != "main" %}
                  <label style="display:block;padding:0.25em 0;">
                    <input type="checkbox" name="devices" value="{{ device.name }}"> {{ device.name }}
                  </label>
                {% endif %}
              {% endfor %}
            {% else %}
              <p>No authorized devices available.</p>
            {% endif %}
          </div>

          <div style="display:flex;gap:0.6em;justify-content:flex-end;">
            <button type="button" class="save_btn" onclick="closeUpdateModal()">Cancel</button>
            <button type="submit" class="save_btn" style="background-color:#2a7;">Start Update</button>
          </div>
        </form>
      </div>
    </div>

  {% else %}
    <p>No firmware files uploaded yet.</p>
  {% endif %}

<script src="{{ url_for('static', filename='js/manage_devices.js') }}"></script>

{% endblock %}
